# 任务管理功能说明

## 功能概述

为微信机器人添加了完整的任务管理功能，支持创建、查询、更新任务，并具备依赖管理和定时提醒功能。

## 核心功能

### 1. 任务创建
- 支持通过自然语言创建任务
- 自动记录创建时间、创建人
- 支持设置截止时间
- 支持设置前置依赖任务
- 自动防止循环依赖

### 2. 任务查询
- 列出所有任务
- 按状态筛选任务
- 获取任务详情
- 统计任务数量

### 3. 任务管理
- 更新任务状态
- 删除任务（需检查依赖）
- 防止循环依赖

### 4. 定时提醒
- 自动检测过期任务
- 检测即将到期任务（24小时内）
- 每小时自动检查

## 使用方法

### 创建任务

**触发方式**: 在群聊中对机器人说"记录任务"或类似表达

**示例对话**:
```
用户: 记录任务：完成项目文档，明天下午3点前完成
机器人: [自动调用 create_task 工具]
机器人: 任务创建成功！
📋 任务: 完成项目文档
状态: 待处理
创建人: 张三
创建时间: 2024-11-30 10:00:00
截止时间: 2024-12-01 15:00:00
ID: xxx-xxx-xxx
```

**支持的参数**:
- 任务标题（必需）
- 任务内容（可选）
- 创建人（自动从消息中提取）
- 截止时间（可选，默认24小时后）
- 依赖任务（可选，任务ID列表）

### 查询任务

**查看所有任务**:
```
用户: 列出所有任务
机器人: 📋 任务列表 (共 3 个):
1. ⏳ 完成项目文档
   创建人: 张三 | 截止: 2024-12-01 15:00
...
```

**按状态查询**:
```
用户: 列出待处理的任务
用户: 列出已完成的任务
```

**查看任务数量**:
```
用户: 有多少个任务？
机器人: 📊 全部任务数量: 5 个
```

**查看任务详情**:
```
用户: 查看任务 xxx-xxx-xxx
机器人: [显示完整任务信息]
```

### 更新任务状态

```
用户: 将任务 xxx-xxx-xxx 标记为进行中
用户: 完成任务 xxx-xxx-xxx
```

**支持的状态**:
- `pending` - 待处理
- `in_progress` - 进行中
- `completed` - 已完成
- `cancelled` - 已取消

## 任务数据结构

```json
{
  "id": "任务唯一ID",
  "title": "任务标题",
  "content": "任务具体内容",
  "creator": "创建人",
  "create_time": "2024-11-30T10:00:00Z",
  "due_time": "2024-12-01T15:00:00Z",
  "dependencies": ["依赖任务ID1", "依赖任务ID2"],
  "status": "pending",
  "completed_time": null
}
```

## 依赖管理

### 防止循环依赖

系统会自动检测并阻止循环依赖：

**示例**:
- 任务A依赖任务B
- 任务B依赖任务C
- 如果尝试让任务C依赖任务A，系统会拒绝并提示错误

### 删除任务限制

如果任务被其他任务依赖，无法删除：

```
用户: 删除任务 xxx
机器人: 无法删除任务 xxx: 任务 yyy 依赖它
```

## 定时提醒

系统每小时自动检查：
1. **过期任务**: 截止时间已过但未完成的任务
2. **即将到期任务**: 24小时内到期的任务

提醒信息会记录在日志中，后续可以扩展为微信消息提醒。

## 数据存储

- **存储位置**: `tasks.json`（项目根目录）
- **存储格式**: JSON
- **实时同步**: 每次操作后立即保存
- **自动加载**: 程序启动时自动加载

## Agent 工具列表

### 1. create_task
创建新任务

**参数**:
- `title` (string, 必需): 任务标题
- `content` (string, 可选): 任务内容
- `creator` (string, 必需): 创建人
- `due_time` (string, 可选): 截止时间
- `dependencies` (array, 可选): 依赖任务ID列表

### 2. list_tasks
列出任务

**参数**:
- `status` (string, 可选): 状态筛选

### 3. get_task_count
获取任务数量

**参数**:
- `status` (string, 可选): 状态筛选

### 4. get_task
获取任务详情

**参数**:
- `task_id` (string, 必需): 任务ID

### 5. update_task_status
更新任务状态

**参数**:
- `task_id` (string, 必需): 任务ID
- `status` (string, 必需): 新状态

## 使用示例

### 示例 1: 创建简单任务

```
用户: 记录任务：明天完成代码审查
机器人: 任务创建成功！
📋 任务: 明天完成代码审查
状态: 待处理
创建人: 李四
创建时间: 2024-11-30 14:30:00
截止时间: 2024-12-01 14:30:00
ID: abc-123-def
```

### 示例 2: 创建带依赖的任务

```
用户: 记录任务：部署到生产环境，依赖任务 abc-123-def，12月5日前完成
机器人: 任务创建成功！
📋 任务: 部署到生产环境
状态: 待处理
创建人: 王五
依赖任务: 1个
...
```

### 示例 3: 查询任务

```
用户: 有多少个待处理的任务？
机器人: 📊 待处理任务数量: 3 个

用户: 列出所有任务
机器人: 📋 任务列表 (共 5 个):
1. ⏳ 完成项目文档
2. 🔄 代码审查
3. ✅ 测试用例编写
...
```

## 注意事项

1. **任务ID**: 系统自动生成唯一ID，用于后续操作
2. **时间格式**: 支持多种时间格式，推荐使用 "2006-01-02 15:04:05"
3. **依赖检查**: 创建任务时会自动检查依赖是否存在
4. **数据持久化**: 所有操作立即保存到文件
5. **并发安全**: 使用读写锁保证并发安全

## 扩展建议

1. **微信提醒**: 将定时提醒扩展为微信消息
2. **任务搜索**: 支持按标题、内容搜索任务
3. **任务排序**: 支持按时间、状态排序
4. **任务标签**: 添加标签分类功能
5. **任务优先级**: 添加优先级字段
6. **任务评论**: 支持任务评论和讨论

---

**最后更新**: 2024年
**功能版本**: v1.0

